name: CI - Build, Test, Coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: windows-latest
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.0.x"

      - name: Verify project constraints
        run: .\verify-constraints.ps1
        shell: pwsh

      - name: Restore
        run: dotnet restore --verbosity minimal

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run tests with coverage
        run: |
          # Use the test project path directly and a relative results directory to avoid path duplication
          dotnet test "calculator.tests/Calculator.Tests.csproj" --configuration Release --collect:"XPlat Code Coverage" --results-directory "calculator.tests\TestResults"
        shell: pwsh

      - name: Install ReportGenerator
        run: |
          dotnet tool install --global dotnet-reportgenerator-globaltool --version 5.1.23
          # Ensure the dotnet tools folder is on PATH for the current PowerShell session
          $env:PATH = "$env:USERPROFILE\.dotnet\tools;${env:PATH}"
        shell: pwsh

      - name: Generate HTML coverage report
        run: |
          # Ensure the dotnet tools folder is on PATH for the current PowerShell session
          $env:PATH = "$env:USERPROFILE\.dotnet\tools;${env:PATH}"
          $cov = Get-ChildItem -Path 'calculator.tests\TestResults' -Recurse -Filter 'coverage.cobertura.xml' -File | Select-Object -First 1
          if (-not $cov) { Write-Error 'No coverage file found'; exit 1 }
          reportgenerator "-reports:$($cov.FullName)" "-targetdir:coverage-report" -reporttypes:Html
        shell: pwsh

      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report

      - name: Enforce coverage threshold (50%)
        run: |
          $coverageFile = Get-ChildItem -Path 'calculator.tests\TestResults' -Recurse -Filter 'coverage.cobertura.xml' -File | Select-Object -First 1
          if (-not $coverageFile) { Write-Error 'Coverage file not found'; exit 1 }
          Write-Host "Found coverage file: $($coverageFile.FullName)"
          [xml]$xml = Get-Content $coverageFile.FullName
          $lineRate = $xml.coverage.'@line-rate'
          if (-not $lineRate) {
            $node = Select-Xml -Path $coverageFile.FullName -XPath '/coverage' | Select-Object -First 1
            $lineRate = $node.Node.Attributes['line-rate'].Value
          }
          if (-not $lineRate) { Write-Error 'Could not parse line-rate from coverage file'; exit 1 }
          Write-Host "Line coverage: $lineRate"
          if ([double]$lineRate -lt 0.5) { Write-Error "Coverage below threshold: $lineRate"; exit 1 } else { Write-Host "Coverage OK: $lineRate" }
        shell: pwsh
