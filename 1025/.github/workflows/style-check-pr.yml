name: PR Style Check

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - "**/*.cs"

permissions:
  contents: read
  pull-requests: write

jobs:
  style-check:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for comparing with base branch

      - name: Get changed C# files
        id: changed-files
        run: |
          # Get the list of changed .cs files in this PR
          $changedFiles = git diff --name-only --diff-filter=ACMRT origin/${{ github.base_ref }}..HEAD | Where-Object { $_ -match '\.cs$' }

          if ($changedFiles) {
            Write-Host "Changed C# files:"
            $changedFiles | ForEach-Object { Write-Host "  - $_" }

            # Save to output
            $filesJson = $changedFiles | ConvertTo-Json -Compress
            echo "files=$filesJson" >> $env:GITHUB_OUTPUT
            echo "has_changes=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No C# files changed"
            echo "has_changes=false" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Create style evaluation prompt
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          $files = '${{ steps.changed-files.outputs.files }}' | ConvertFrom-Json

          Write-Host "`n=== Creating Style Evaluation Prompt ===`n"

          # Read the base prompt template
          $promptTemplate = Get-Content .github/prompts/evaluate-csharp-style.prompt.md -Raw

          # Build the files section
          $filesSection = "`n`n## Files to Evaluate`n`n"

          foreach ($file in $files) {
            if (Test-Path $file) {
              $content = Get-Content $file -Raw
              $filesSection += "### File: $file`n"
              $filesSection += '```csharp' + "`n"
              $filesSection += $content
              $filesSection += "`n" + '```' + "`n`n"
            }
          }

          # Replace the placeholder in the template with actual files
          $prompt = $promptTemplate -replace '---\s*\r?\n<!-- Insert C# code files here -->\s*\r?\n---', $filesSection

          $prompt | Out-File -FilePath "style-evaluation-prompt.txt" -Encoding UTF8
          Write-Host "‚úÖ Prompt file created: style-evaluation-prompt.txt"
          Write-Host "Prompt size: $($prompt.Length) characters"
          Write-Host "Files included: $($files.Count)"
        shell: pwsh

      - name: Evaluate C# style compliance using AI
        if: steps.changed-files.outputs.has_changes == 'true'
        id: style-check
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          Write-Host "`n=== Evaluating C# Style Compliance with AI ===`n"

          # Read the prompt
          $prompt = Get-Content "style-evaluation-prompt.txt" -Raw
          Write-Host "Prompt size: $($prompt.Length) characters"

          # NOTE: GitHub Copilot CLI (gh copilot) is designed for shell command suggestions,
          # not for structured code analysis. We need to use OpenAI API directly.

          if ([string]::IsNullOrEmpty($env:OPENAI_API_KEY)) {
            Write-Host "‚ö†Ô∏è OPENAI_API_KEY not configured - using placeholder"
            Write-Host ""
            Write-Host "To enable real AI evaluation:"
            Write-Host "1. Get API key from https://platform.openai.com/api-keys"
            Write-Host "2. Add as repository secret: OPENAI_API_KEY"
            Write-Host "3. Re-run workflow"
            Write-Host ""
            Write-Host "üìÑ Prompt saved to artifacts for manual review"

            # Placeholder evaluation
            $evaluation = @{
              result = "pass"
              summary = @{
                totalFiles = 0
                filesWithViolations = 0
                majorViolations = 0
                minorViolations = 0
              }
              violations = @()
              note = "OpenAI API key not configured"
            }
          } else {
            Write-Host "‚úÖ Using OpenAI API for evaluation"

            try {
              # Prepare API request
              $headers = @{
                "Authorization" = "Bearer $env:OPENAI_API_KEY"
                "Content-Type" = "application/json"
              }

              $body = @{
                model = "gpt-4o-mini"
                messages = @(
                  @{
                    role = "system"
                    content = "You are a C# code style reviewer. Return ONLY valid JSON matching the exact format specified in the prompt. Do not include markdown formatting or explanations."
                  },
                  @{
                    role = "user"
                    content = $prompt
                  }
                )
                temperature = 0.1
                response_format = @{ type = "json_object" }
              } | ConvertTo-Json -Depth 10

              Write-Host "Calling OpenAI API..."
              $response = Invoke-RestMethod `
                -Uri "https://api.openai.com/v1/chat/completions" `
                -Method Post `
                -Headers $headers `
                -Body $body `
                -ContentType "application/json"

              $responseContent = $response.choices[0].message.content
              Write-Host "‚úÖ API response received: $($responseContent.Length) characters"

              # Parse JSON response
              $evaluation = $responseContent | ConvertFrom-Json
              Write-Host "‚úÖ JSON parsed successfully"

              if ($evaluation.summary) {
                Write-Host "   Files evaluated: $($evaluation.summary.totalFiles)"
                Write-Host "   Files with violations: $($evaluation.summary.filesWithViolations)"
                Write-Host "   Major violations: $($evaluation.summary.majorViolations)"
                Write-Host "   Minor violations: $($evaluation.summary.minorViolations)"
              }

            } catch {
              Write-Host "`n‚ùå Error calling OpenAI API: $_"
              Write-Host "Error type: $($_.Exception.GetType().FullName)"
              Write-Host "Error message: $($_.Exception.Message)"

              if ($_.Exception.Response) {
                Write-Host "Status code: $($_.Exception.Response.StatusCode)"
              }

              # Fallback: pass but log error
              $evaluation = @{
                result = "pass"
                summary = @{
                  totalFiles = 0
                  filesWithViolations = 0
                  majorViolations = 0
                  minorViolations = 0
                }
                violations = @()
                error = "API call failed: $($_.Exception.Message)"
              }
            }
          }

          # Convert to JSON and save
          $evaluation | ConvertTo-Json -Depth 10 | Out-File -FilePath "evaluation-result.json" -Encoding UTF8

          # Set output based on result
          if ($evaluation.result -eq "pass") {
            Write-Host "‚úÖ All changed C# files pass style guidelines"
            echo "result=pass" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "‚ùå Style violations found"
            if ($evaluation.summary) {
              Write-Host "   Total files: $($evaluation.summary.totalFiles)"
              Write-Host "   Files with violations: $($evaluation.summary.filesWithViolations)"
              Write-Host "   Major violations: $($evaluation.summary.majorViolations)"
              Write-Host "   Minor violations: $($evaluation.summary.minorViolations)"
            } else {
              Write-Host "   Total violations: $($evaluation.violations.Count)"
            }
            echo "result=fail" >> $env:GITHUB_OUTPUT

            # Create markdown report from violations
            $report = "## ‚ùå C# Style Check Failed`n`n"

            # Add summary if available
            if ($evaluation.summary) {
              $report += "**Summary:**`n"
              $report += "- üìÅ Files evaluated: $($evaluation.summary.totalFiles)`n"
              $report += "- ‚ö†Ô∏è Files with violations: $($evaluation.summary.filesWithViolations)`n"
              $report += "- üî¥ Major violations: $($evaluation.summary.majorViolations)`n"
              $report += "- ‚ö†Ô∏è Minor violations: $($evaluation.summary.minorViolations)`n`n"
            }

            $report += "The following style violations were found in changed files:`n`n"

            # Group by severity
            $majorViolations = $evaluation.violations | Where-Object { $_.severity -eq "Major" }
            $minorViolations = $evaluation.violations | Where-Object { $_.severity -eq "Minor" }

            if ($majorViolations) {
              $report += "### üî¥ Major Violations`n`n"
              $report += "| File | Category | Issue |`n"
              $report += "|------|----------|-------|`n"
              foreach ($v in $majorViolations) {
                $report += "| ``$($v.file)`` | $($v.category) | $($v.issue) |`n"
              }
              $report += "`n"
            }

            if ($minorViolations) {
              $report += "### ‚ö†Ô∏è Minor Violations (Optional)`n`n"
              $report += "| File | Category | Issue |`n"
              $report += "|------|----------|-------|`n"
              foreach ($v in $minorViolations) {
                $report += "| ``$($v.file)`` | $($v.category) | $($v.issue) |`n"
              }
              $report += "`n"
            }

            $report += "---`n`n"
            $report += "### üìã Style Guidelines`n`n"
            $report += "Please review the style guidelines at: ``.github/instructions/style-instructions.md```n`n"
            $report += "#### Key C# Conventions:`n"
            $report += "- **Classes, Methods, Properties**: PascalCase (e.g., ``Evaluator``, ``Evaluate()``)`n"
            $report += "- **Parameters, Local Variables**: camelCase (e.g., ``expression``, ``result``)`n"
            $report += "- **Private Fields**: _camelCase with underscore prefix (e.g., ``_lastResult``)`n"
            $report += "- **Namespaces**: PascalCase recommended (e.g., ``Calculator.Tests`` vs ``calculator.tests``)`n"

            # Save report to file
            $report | Out-File -FilePath "style-report.md" -Encoding UTF8
          }
        shell: pwsh

      - name: Comment on PR with results
        if: steps.changed-files.outputs.has_changes == 'true' && steps.style-check.outputs.result == 'fail'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('style-report.md', 'utf8');

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('C# Style Check')
            );

            // Update existing comment or create new one
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

      - name: Upload prompt and results as artifacts
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: style-check-results
          path: |
            style-evaluation-prompt.txt
            evaluation-result.json
            style-report.md
          retention-days: 30

      - name: Set status check
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          if ("${{ steps.style-check.outputs.result }}" -eq "fail") {
            Write-Host "‚ùå Style check failed"
            exit 1
          } else {
            Write-Host "‚úÖ Style check passed"
            exit 0
          }
        shell: pwsh

      - name: Comment on PR - No changes
        if: steps.changed-files.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const message = '## ‚úÖ C# Style Check\n\nNo C# files were changed in this PR.';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
